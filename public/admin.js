'use strict';/************************** App modlue *****************************/var adminApp = angular.module('adminApp', [    'ngRoute',    'ngResource',    'dataSourceControllers']);adminApp.config(['$routeProvider',function($routeProvider){    $routeProvider.        when('/dataSource', {            templateUrl:'/public/src/dataSource.html',            controllers: 'dataSourceCtrl'        }).        when('/widget', {            templateUrl: '/public/src/widget.html',            controllers: 'widgetCtrl'        }).        when('/dashboard',{            templateUrl: '/public/src/dashboard.html',            controllers: 'dashboardCtrl'        }).        when('/dataSource/edit/:dataSourceId', {            templateUrl: '/public/src/dataSource_edit.html'        }).        when('/dataSource/new', {            templateUrl: '/public/src/dataSource_new.html',            controllers:'dataSourceNew'        }).        when('/dataSource/delete/:dataSourceId', {            controllers: 'dataSourceDelete'        }).        otherwise({        });}]);adminApp.service('DataSource', function($resource){    return $resource('/api/data_sources/');});adminApp.controller('dataSourceCtrl', ['$scope', '$http',    function($scope, $http){        $http.get('/api/data_sources').success(function(data){            data.forEach(function(dataSource){                $http.get('/api/projects/' + dataSource.project_id).success(function(project){                    dataSource.project_uuid = project.uuid;                });            });            $scope.dataSources = data;            $scope.delete = function(){            };        });    }]);adminApp.controller('NavCtrl', function ($scope, $rootScope) {    $scope.active = 'dashboard';    $rootScope.$on('$routeChangeSuccess', function(current, routes){        if(routes.loadedTemplateUrl === '/public/src/dataSource.html' || routes.loadedTemplateUrl === '/public/src/dataSource_edit.html'){            $scope.active = 'dataSource';        }        else if(routes.loadedTemplateUrl === '/public/src/widget.html'){            $scope.active = 'widget';        }        else if(routes.loadedTemplateUrl === '/public/src/dashboard.html'){            $scope.active = 'dashboard';        }    });});/************************** dataSource Controllers *****************************/var dataSourceControllers = angular.module('dataSourceControllers', [    'ngResource']);dataSourceControllers.service('Project', function ($resource) {    return $resource('/api/projects/:id');});dataSourceControllers.factory('DataSource', ['$resource', function($resource){    return $resource('/api/data_sources/:id', null, {        'update': {method: 'PUT'}    });}]);dataSourceControllers.factory('RecordSave', function($resource){    return $resource('/api/projects/:uuid/data_sources/:key');});dataSourceControllers.service('Record', function($resource){    return $resource('/api/data_sources/:id/records');});dataSourceControllers.service('RecordDelete', function($resource){    return $resource('/api/records/:id');});dataSourceControllers.controller('dataSourceInfo', ['$scope', '$routeParams', 'DataSource', 'Project',    function($scope, $routeParams, DataSource, Project) {        $scope.dataSource = DataSource.get({id: $routeParams.dataSourceId});        $scope.projects = Project.query();        $scope.submit = function () {            //提交后给出成功操作的提示            DataSource.update({id: $scope.dataSource.id}, $scope.dataSource);        };    }]);dataSourceControllers.controller('dataSourceMethod', ['$scope', '$routeParams', 'Project', 'DataSource',    function ($scope, $routeParams, Project, DataSource) {        DataSource.get({id: $routeParams.dataSourceId}).$promise.then(function (ds) {            $scope.project = Project.get({                id: ds.project_id            });        });        $scope.showJsonExample = JSON.stringify({            value: 100,            year: 2014,            month: 7,            day: 3,            hour: 16,            minute: 0,            second: 0        }, null, 4);        $scope.dataSource = DataSource.get({id: $routeParams.dataSourceId});    }]);dataSourceControllers.controller('dataSourceTest', ['$rootScope', '$scope', '$routeParams', 'RecordSave', 'Project', 'DataSource',    function($rootScope, $scope, $routeParams, RecordSave, Project, DataSource){        $scope.data = JSON.stringify({            value: 100,            year: 2014,            month: 7,            day: 3,            hour: 16,            minute: 0,            second: 0        }, null, 4);        DataSource.get({id: $routeParams.dataSourceId}).$promise.then(function (ds) {            $scope.dataSource = ds;            $scope.project = Project.get({                id: ds.project_id            });        });        $scope.submit = function(){            var data = JSON.parse($scope.data);            RecordSave.save({                uuid: $scope.project.uuid,                key: $scope.dataSource.key            }, data).$promise.then(function (record) {                $rootScope.$broadcast('newRecord', record);            });        };    }]);dataSourceControllers.controller('dataSourceRecords', ['$rootScope', '$scope', '$routeParams', 'Record', 'DataSource', 'RecordDelete',    function($rootScope, $scope, $routeParams, Record, DataSource, RecordDelete){        $scope.records = Record.query({            id: $routeParams.dataSourceId,            orderBy: 'created_at',            limit: 10        });        $scope.getDataSource = function(id){            return DataSource.get({                id: id            });        };        $scope.delete = function (record) {            //删除Record后刷新Record List            RecordDelete.delete({                id: record.id            }).$promise.then(function () {                var idx = $scope.records.indexOf(record);                if (idx === -1) {                    return;                }                $scope.records.splice(idx, 1);            });        };        $rootScope.$on('newRecord', function (event, record) {            $scope.records.unshift(record);        });    }]);dataSourceControllers.controller('dataSourceNew', ['$scope', 'DataSource', 'Project',    function($scope, DataSource, Project) {            $scope.projects = Project.query();            $scope.dataSource = {};            $scope.invalid = {};            $scope.submit = function () {                //验证表单数据是否合法                var valid = true;                if($scope.dataSource.name === undefined){                    $scope.invalid.name = 'ng-invalid ng-dirty';                    valid = false;                }                if($scope.dataSource.project_id === undefined){                    $scope.invalid.project_id = 'ng-invalid ng-dirty';                    valid = false;                }                if($scope.dataSource.key === undefined){                    $scope.invalid.key = 'ng-invalid ng-dirty';                    valid = false;                }                if(!valid){                    return ;                }                //提交后给出成功操作的提示                DataSource.save(null, $scope.dataSource).$promise.then(function(dataSource){                    location.href = '#dataSource/edit/' + dataSource.id;                });            };        }]);