/*jshint maxparams: 10*//*global angular: true*/'use strict';var widgetTypes = [    {        type: 1,        label: 'Spline'    },    {        type: 2,        label: 'Pie'    },    {        type: 3,        label: 'Donut'    },    {        type: 4,        label: 'Number'    }];/************************** services modlue *****************************/var services = angular.module('services', [    'ngResource']);services.service('DataSource', function($resource){    return $resource('/api/data_sources/:id', null, {            'update': {method: 'PUT'}        });});services.service('Project', function($resource){    return $resource('/api/projects/:id');});services.service('Widget', function($resource){    return $resource('/api/dashboards/:dashboardid/widgets/:id', null, {        'update': {method: 'PUT'}    });});services.service('Dashboard', function($resource){    return $resource('/api/dashboards/:id', null, {        'update': {method: 'PUT'}    });});services.service('RecordSave', function($resource){    return $resource('/api/projects/:uuid/data_sources/:key');});services.service('Record', function($resource){    return $resource('/api/data_sources/:id/records');});services.service('RecordDelete', function($resource){    return $resource('/api/records/:id');});/************************** App modlue *****************************/var adminApp = angular.module('adminApp', [    'ngRoute',    'dataSourceControllers',    'dashboardControllers',    'services']);adminApp.config(['$routeProvider',function($routeProvider){    $routeProvider.        //dataSource        when('/dataSource', {            templateUrl:'/public/src/dataSource.html',            controllers: 'dataSourceCtrl'        }).        when('/dataSource/edit/:dataSourceId', {            templateUrl: '/public/src/dataSource_edit.html'        }).        when('/dataSource/new', {            templateUrl: '/public/src/dataSource_new.html',            controllers:'dataSourceNewCtrl'        }).        when('/dataSource/delete/:dataSourceId', {            controllers: 'dataSourceDeleteCtrl'        }).        //dashboard        when('/dashboard', {            templateUrl: '/public/src/dashboard.html',            controllers: 'dashboardCtrl'        }).        when('/dashboard/edit/:dashboardId', {            templateUrl: '/public/src/dashboard_edit.html',            controllers: 'dashboardEditCtrl'        }).        when('/dashboard/new', {            templateUrl: '/public/src/dashboard_new.html',            controllers: 'dashboardNewCtrl'        }).        otherwise({        });}]);adminApp.controller('dataSourceCtrl', ['$scope', 'DataSource', 'Project',    function($scope, DataSource, Project){        DataSource.query().$promise.then(function(dataSources){            dataSources.forEach(function(dataSource){                Project.get({id: dataSource.project_id}).$promise.then(function(project){                    dataSource.project_uuid = project.uuid;                });            });            $scope.dataSources = dataSources;            $scope.delete = function(dataSource){                DataSource.delete({                    id: dataSource.id                }).$promise.then(function () {                    var idx = $scope.dataSources.indexOf(dataSource);                    if (idx === -1) {                        return;                    }                    $scope.dataSources.splice(idx, 1);                });            };        });    }]);adminApp.controller('dashboardCtrl', ['$scope', 'Dashboard', 'Widget',    function($scope, Dashboard, Widget){        Dashboard.query().$promise.then(function(dashboards) {            $scope.dashboards = dashboards;            $scope.dashboards.forEach(function(dashboard){                Widget.query({dashboardid: dashboard.id}).$promise.then(function (widgets) {                    dashboard.widgets = widgets;                });            });        });        $scope.delete = function(dashboard){            Widget.query({                dashboardid: dashboard.id            }).$promise.then(function(widgets){                widgets.forEach(function(widget){                    Widget.delete({                        dashboardid: dashboard.id,                        id: widget.id                    });                });            }).then(function(){                Dashboard.delete({                    id: dashboard.id                }).$promise.then(function(){                    var idx = $scope.dashboards.indexOf(dashboard);                    if(idx === -1){                        return ;                    }                    $scope.dashboards.splice(idx, 1);                });            });        };    }]);adminApp.controller('widgetCtrl', ['$scope', 'Widget', 'Dashboard', 'DataSource',    function($scope, Widget, Dashboard){        Dashboard.query().$promise.then(function(dashboards){            $scope.widgets = [];            dashboards.forEach(function(dashboard){                Widget.query({dashboardid: dashboard.id}).$promise.then(function(widgets){                    $scope.widgets.push(widgets);                });            });        });    }]);adminApp.controller('NavCtrl', function ($scope, $rootScope) {    $scope.active = 'dashboard';    $rootScope.$on('$routeChangeSuccess', function(current, routes){        if(routes.loadedTemplateUrl === '/public/src/dataSource.html' || routes.loadedTemplateUrl === '/public/src/dataSource_edit.html'){            $scope.active = 'dataSource';        }//        else if(routes.loadedTemplateUrl === '/public/src/widget.html'){//            $scope.active = 'widget';//        }        else if(routes.loadedTemplateUrl === '/public/src/dashboard.html'){            $scope.active = 'dashboard';        }    });});/************************** dataSource Controllers *****************************/var dataSourceControllers = angular.module('dataSourceControllers', [    'services']);dataSourceControllers.controller('dataSourceInfoCtrl', ['$scope', '$routeParams', 'DataSource', 'Project',    function($scope, $routeParams, DataSource, Project) {        DataSource.get({id: $routeParams.dataSourceId}).$promise.then(function(dataSource){            $scope.dataSource = dataSource;        });        Project.query().$promise.then(function(projects){            $scope.projects = projects;        });        $scope.invalid = {};        $scope.submit = function () {            //验证表单数据是否合法            var valid = true;            if (!$scope.dataSource.name) {                $scope.invalid.name = 'ng-invalid ng-dirty';                valid = false;            }            if (!$scope.dataSource.project_id) {                $scope.invalid.project_id = 'ng-invalid ng-dirty';                valid = false;            }            if (!$scope.dataSource.key) {                $scope.invalid.key = 'ng-invalid ng-dirty';                valid = false;            }            if (!valid) {                return;            }            //提交后给出成功操作的提示            DataSource.update({id: $scope.dataSource.id}, $scope.dataSource);        };    }]);dataSourceControllers.controller('dataSourceMethodCtrl', ['$scope', '$routeParams', 'Project', 'DataSource',    function ($scope, $routeParams, Project, DataSource) {        DataSource.get({id: $routeParams.dataSourceId}).$promise.then(function (ds) {            $scope.project = Project.get({                id: ds.project_id            });        });        $scope.showJsonExample = JSON.stringify({            value: 100,            year: 2014,            month: 7,            day: 3,            hour: 16,            minute: 0,            second: 0        }, null, 4);        $scope.dataSource = DataSource.get({id: $routeParams.dataSourceId});    }]);dataSourceControllers.controller('dataSourceTestCtrl', ['$rootScope', '$scope', '$routeParams', 'RecordSave', 'Project', 'DataSource',    function($rootScope, $scope, $routeParams, RecordSave, Project, DataSource){        $scope.data = JSON.stringify({            value: 100,            year: 2014,            month: 7,            day: 3,            hour: 16,            minute: 0,            second: 0        }, null, 4);        DataSource.get({id: $routeParams.dataSourceId}).$promise.then(function (ds) {            $scope.dataSource = ds;            $scope.project = Project.get({                id: ds.project_id            });        });        $scope.submit = function(){            var data = JSON.parse($scope.data);            RecordSave.save({                uuid: $scope.project.uuid,                key: $scope.dataSource.key            }, data).$promise.then(function (record) {                $rootScope.$broadcast('newRecord', record);            });        };    }]);dataSourceControllers.controller('dataSourceRecordsCtrl', ['$rootScope', '$scope', '$routeParams', 'Record', 'DataSource', 'RecordDelete',    function($rootScope, $scope, $routeParams, Record, DataSource, RecordDelete){        $scope.records = Record.query({            id: $routeParams.dataSourceId,            orderBy: 'created_at',            limit: 10        });        $scope.getDataSource = function(id){            return DataSource.get({                id: id            });        };        $scope.delete = function (record) {            //删除Record后刷新Record List            RecordDelete.delete({                id: record.id            }).$promise.then(function () {                var idx = $scope.records.indexOf(record);                if (idx === -1) {                    return;                }                $scope.records.splice(idx, 1);            });        };        $rootScope.$on('newRecord', function (event, record) {            $scope.records.unshift(record);        });    }]);dataSourceControllers.controller('dataSourceNewCtrl', ['$scope', '$location', 'DataSource', 'Project',    function($scope, $location, DataSource, Project) {            $scope.projects = Project.query();            $scope.dataSource = {};            $scope.submit = function () {                //提交后给出成功操作的提示                DataSource.save($scope.dataSource).$promise.then(function(dataSource){                    $location.url('/dataSource/edit/' + dataSource.id);                });            };        }]);/************************** dashboard Controllers *****************************/var dashboardControllers = angular.module('dashboardControllers', [    'ngResource',    'services',    'ui.bootstrap']);dashboardControllers.controller('dashboardNewCtrl', ['$scope', '$location', 'Dashboard',    function($scope, $location, Dashboard){    $scope.dashboard = {};    $scope.submit = function(){        Dashboard.save(null, $scope.dashboard).$promise.then(function(dashboard){            $location.url('/dashboard/edit/' + dashboard.id);        });    };}]);dashboardControllers.controller('dashboardEditCtrl', ['$scope', '$routeParams', 'Dashboard', 'Widget',    function($scope, $routeParams, Dashboard, Widget){        Dashboard.get({id: $routeParams.dashboardId}).$promise.then(function(dashboard){            $scope.dashboard = dashboard;            $scope.dashboard.config = $scope.dashboard.config || {};            $scope.dashboard.config.layout = $scope.dashboard.config.layout || {};            $scope.dashboard.config.layout.rows = $scope.dashboard.config.layout.rows || [];            Widget.query({                dashboardid: $routeParams.dashboardId            }).$promise.then(function(widgets){                $scope.widgets = widgets;            });        });        $scope.invalid = {};        $scope.checkSpan = function (row) {            var length = 0;            row.columns.forEach(function(col){                length += col.span;            });            if(length >= 12){                return false;            }            return true;        };        $scope.updateDashboardConfig = function(){            Dashboard.update({                id: $scope.dashboard.id            }, $scope.dashboard);        };        $scope.updateDashboardName = function(){            if($scope.dashboard.name === ''){                return ;            }            Dashboard.update({                id: $scope.dashboard.id            }, $scope.dashboard);        };        $scope.addRow = function(){            var newRow = {                columns: []            };            $scope.dashboard.config.layout.rows.push(newRow);        };        $scope.deleteCol = function(col, row){            var idx = row.columns.indexOf(col);            if (idx !== -1) {                row.columns.splice(idx, 1);                if (row.columns.length === 0) {                    idx = $scope.dashboard.config.layout.rows.indexOf(row);                    if (idx !== -1) {                        $scope.dashboard.config.layout.rows.splice(idx, 1);                    }                }                Dashboard.update({                    id: $routeParams.dashboardId                }, $scope.dashboard).$promise.then(function (dashboard) {                    Widget.delete({                        dashboardid: dashboard.id,                        id: col.id                    });                });            }        };        $scope.getOnResizeEnd = function (col) {            return function (span) {                col.span = span;                $scope.$digest();                Dashboard.update({                    id: $routeParams.dashboardId                }, $scope.dashboard);            };        };    }]).directive('resizeable', function(){    return {        restrict: 'A',        scope: {            resizableConfig: '=resizeOptions',            onResizeEnd: '&onResizeEnd'        },        link: function postLink(scope, elem){            var callback = scope.onResizeEnd();            var grid = null;            var parent = elem.closest('.row');            elem.on('resizestart', function () {                parent.height(parent.height());                var children = parent.children('.widget-placeholder-wrap').not(elem);                var width = parent.width();                var range = 12;                children.each(function () {                    var $child = angular.element(this);                    range -= parseInt($child.attr('data-span'), 10);                    width -= $child.width();                });                grid = width / range;                elem.resizable('option', {                    maxWidth: Math.floor(width) - 1,                    minWidth: grid                });            });            elem.resizable(scope.resizableConfig);            elem.on('resizestop', function(){                var span = Math.round(elem.width() / grid);                callback(span);                elem.attr('style', null);                parent.attr('style', null);            });        }    };});dashboardControllers.controller('newModalCtrl', ['$scope', '$modal', 'Dashboard',    function ($scope, $modal, Dashboard) {        var newWidgetModalInstanceCtrl = ['$scope', 'Widget', 'DataSource', '$modalInstance', 'dashboard', 'row',            function ($scope, Widget, DataSource, $modalInstance, dashboard, row) {                $scope.widget = {};                $scope.widget.config = {};                $scope.widgetConfig = {};                $scope.dashboard = dashboard;                $scope.widgetTypes = widgetTypes;                $scope.addToRow = row;                $scope.addedDataInfo = {};                var length = 0;                $scope.addToRow.columns.forEach(function (col) {                    length += col.span;                });                $scope.maxSpan = 12 - length;                $scope.minSpan = 1;                DataSource.query().$promise.then(function (dataSources) {                    $scope.dataSources = dataSources;                });                $scope.addDataInfo = function(){                    $scope.isAddDataInfo = true;                };                $scope.deleteDataInfo = function(dataInfo){                    var idx = $scope.widget.config.dataInfos.indexOf(dataInfo);                    if(idx === -1){                        return ;                    }                    $scope.widget.config.dataInfos.splice(idx, 1);                };                $scope.addOk = function(){                    if(!$scope.addedDataInfo.id){                        return ;                    }                    DataSource.get({                        id: $scope.addedDataInfo.id                    }).$promise.then(function(dataSource){                        $scope.widget.config.dataInfos = $scope.widget.config.dataInfos || [];                        $scope.widget.config.dataInfos.push({                            id: $scope.addedDataInfo.id,                            dataSource: dataSource                        });                        $scope.isAddDataInfo = false;                        $scope.addedDataInfo = {};                    });                };                $scope.addCancel = function(){                    $scope.isAddDataInfo = false;                };                $scope.ok = function () {                    $scope.widget.dashboard_id = $scope.dashboard.id;                    Widget.save({                        dashboardid: $scope.dashboard.id                    }, $scope.widget).$promise.then(function (widget) {                            $scope.widgetConfig.id = widget.id;                            $modalInstance.close({                                config: $scope.widgetConfig,                                widget: widget                            });                        });                };                $scope.cancel = function () {                    $modalInstance.dismiss('cancel');                };            }        ];        $scope.open = function (row) {            var newWidgetModalInstance = $modal.open({                templateUrl: '/public/src/include/widget_new_modal.html',                controller: newWidgetModalInstanceCtrl,                resolve: {                    dashboard: function () {                        return $scope.dashboard;                    },                    row: function () {                        return row;                    }                }            });            newWidgetModalInstance.result.then(function (result) {                var widgetConfig = result.config;                var widget = result.widget;                $scope.widgets.push(widget);                row.columns.push(widgetConfig);                Dashboard.update({                    id: $scope.dashboard.id                }, $scope.dashboard);            });        };    }]);dashboardControllers.controller('editModalCtrl', ['$scope', '$modal', 'DataSource',    function($scope, $modal, DataSource){        var editWidgetModalInstanceCtrl = ['$scope', 'Widget', 'DataSource', '$modalInstance', 'dashboard', 'col',            function ($scope, Widget, DataSource, $modalInstance, dashboard, col) {                $scope.widget = {};                $scope.widgetTypes = widgetTypes;                $scope.addedDataInfo = {};                Widget.get({                    dashboardid: dashboard.id,                    id: col.id                }).$promise.then(function(widget){                    $scope.widget = widget;                    $scope.widget.config.dataInfos = $scope.widget.config.dataInfos || [];                    $scope.widget.config.dataInfos.forEach(function(dataInfo, idx){                        DataSource.get({                            id: dataInfo.id                        }).$promise.then(function(dataSource){                            $scope.widget.config.dataInfos[idx].dataSource = dataSource;                        });                    });                });                DataSource.query().$promise.then(function(dataSources){                    $scope.dataSources = dataSources;                });                $scope.addDataInfo = function(){                    $scope.isAddDataInfo = true;                };                $scope.deleteDataInfo = function(dataInfo){                    var idx = $scope.widget.config.dataInfos.indexOf(dataInfo);                    if(idx === -1){                        return ;                    }                    $scope.widget.config.dataInfos.splice(idx, 1);                };                $scope.addOk = function(){                    if(!$scope.addedDataInfo.id){                        return ;                    }                    DataSource.get({                        id: $scope.addedDataInfo.id                    }).$promise.then(function(dataSource){                        $scope.widget.config.dataInfos = $scope.widget.config.dataInfos || [];                        $scope.widget.config.dataInfos.push({                            id: $scope.addedDataInfo.id,                            dataSource: dataSource                        });                        $scope.isAddDataInfo = false;                        $scope.addedDataInfo = {};                    });                };                $scope.addCancel = function(){                    $scope.isAddDataInfo = false;                };                $scope.ok = function () {                    Widget.update({                        dashboardid: dashboard.id,                        id: $scope.widget.id                    }, $scope.widget).$promise.then(function(){                        $modalInstance.close($scope.widget);                    });                };                $scope.cancel = function () {                    $modalInstance.dismiss('cancel');                };            }        ];        $scope.open = function (col) {            var editWidgetModalInstance = $modal.open({                templateUrl: '/public/src/include/widget_edit_modal.html',                controller: editWidgetModalInstanceCtrl,                resolve: {                    dashboard: function () {                        return $scope.dashboard;                    },                    col: function () {                        return col;                    }                }            });            editWidgetModalInstance.result.then(function (updatedWidget) {                $scope.widgets.forEach(function(widget, idx){                    if(widget.id === updatedWidget.id){                        $scope.widgets[idx] = updatedWidget;                    }                });            });        };    }]);dashboardControllers.controller('confirmDeleteCtrl', ['$scope', '$modal',    function($scope, $modal){        var $outerScope = $scope;        var deleteConfirmModalInstanceCtrl = ['$scope', 'Widget', 'DataSource', '$modalInstance', 'dashboard', 'deleteCol',            function ($scope, Widget, DataSource, $modalInstance, dashboard, deleteCol) {                $scope.ok = function(){                    var col = $outerScope.col;                    var row = $outerScope.row;                    deleteCol(col,row);                    $modalInstance.close();                };                $scope.cancel = function(){                    $modalInstance.dismiss('cancel');                };            }        ];        $scope.open = function () {            var deleteConfirmModalInstance = $modal.open({                templateUrl: 'deleteConfirmModalContent.html',                controller: deleteConfirmModalInstanceCtrl,                resolve: {                    dashboard: function () {                        return $scope.dashboard;                    },                    deleteCol: function() {                        return $scope.deleteCol;                    }                }            });        };    }]);